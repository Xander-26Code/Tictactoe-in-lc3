# Tic-Tac-Toe 汇编代码调试报告 (Debugging Report)

本文档总结了在开发 LC-3 井字棋游戏 (`tictactoegame.asm`) 过程中遇到的所有关键问题及其解决方案。

## 1. 严重逻辑错误 (Critical Logic Errors)

### 1.1 输入验证缺失导致内存破坏 (Memory Corruption via Input)
- **问题**: 原始代码没有过滤非数字输入。当用户输入回车键（Newline, ASCII x0A）时，程序计算 `Input - '0'`，得到 `10 - 48 = -38`。
- **后果**: 程序随后尝试将棋子写入 `BOARD - 38` 的位置。这导致了越界写入，覆盖了代码区的指令，直接破坏了游戏逻辑（如玩家无法切换、死循环等）。
- **修复**: 在 `GET_MOVE` 中增加了白名单验证，仅接受 `'0'` 到 `'8'` 的字符，忽略回车键和其他非法输入。

### 1.2 胜负判定逻辑失效 (Broken Win Check)
- **问题**: 原代码假设获胜组合在内存中是连续的（Index, Index+1, Index+2）。这只对横排有效。
- **后果**: 竖排（如 0, 3, 6）和对角线（0, 4, 8）无法触发胜利判定。
- **修复**: 重写 `CHECK_WIN`，明确地从查找表（LUT）中读取 3 个不连续的索引来验证棋盘。

### 1.3 游戏提前结束 (Premature Draw)
- **问题**: 只要当前步没有人赢，游戏就直接跳转到 `GAME_OVER_DRAW`。
- **后果**: 玩家只能下 1 步，如果不赢就判平局。
- **修复**: 引入 `MOVES_COUNT` 计数器。只有当棋盘下满 9 步且无人获胜时，才判定为平局。

---

## 2. 汇编与编译错误 (Assembly & Compilation Issues)

### 2.1 9位偏移量限制 (9-bit Offset Limit)
- **问题**: LC-3 的 `LD/ST/LDR/STR` 指令只能访问距离当前指令 -256 到 +255 字范围内的标签。由于代码较长，位于文件末尾的子程序无法访问文件开头的 `BOARD` 变量。
- **修复**: 采用 **间接寻址 (Indirect Addressing)**。在子程序末尾定义“本地指针”（如 `PTR_BOARD .FILL BOARD`），子程序先加载本地指针，再通过指针访问远端数据。

### 2.2 非法寻址方式 (Invalid Addressing Mode)
- **问题**: 代码尝试使用寄存器作为 `LDR/STR` 的偏移量（例如 `LDR R2, R1, R3`）。LC-3 汇编语法的偏移量必须是立即数（常数）。
- **修复**: 手动计算地址。
  ```assembly
  ADD R1, R1, R3  ; 基地址 + 索引
  LDR R2, R1, #0  ; 使用 0 偏移量读取
  ```

### 2.3 标签冲突 (Label Conflict)
- **问题**: 直接使用 `CHOOSE_PLAYER` 作为标签名放在代码行首，导致与子程序定义冲突。
- **修复**: 改为 `JSR CHOOSE_PLAYER` 进行正确的子程序调用。

---

## 3. 运行时与显示问题 (Runtime & UI Issues)

### 3.1 乱码输出 (Garbage Output)
- **问题**: 打印单个字符（如换行符）时错误使用了 `PUTS`。`PUTS` 期望寄存器中是字符串的**地址**，而不是字符本身。这导致程序从内存地址 10 开始打印内存垃圾数据。
- **修复**: 将所有单字符打印改为 `OUT` 指令。

### 3.2 棋盘对齐错位 (UI Misalignment)
- **问题**: 竖线 `|` 与横线 `---` 错位，因为没有考虑字符宽度。
- **修复**: 修改输出格式，为每个棋子左右添加空格（`[空格][棋子][空格]`），并将横线调整为 `---|---|---`，实现完美对齐。

### 3.3 缺少交互提示 (Missing Prompts)
- **问题**: 游戏只打印棋盘，不提示当前轮到谁，用户体验差。
- **修复**: 添加了动态提示文本：`Player X, enter your move (0-8):`。
